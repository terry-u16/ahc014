# AHC014日記

## 1日目（土）

問題を読んだ。なにこれ。むずすぎ。

点を4つ選ぶ問題、どこかで見たことあるな。 → [JOI2007本戦C 最古の遺跡](https://atcoder.jp/contests/joi2007ho/tasks/joi2007ho_c)。ベクトルを使うと便利そう。

点ごとの得点分布ってどうなるんだろ。伝家の宝刀†Excel†を使おうと思ったが、複数回使う機会がありそうなのでPythonの方が良いか。

可視化した。思った以上に四隅のウェイトが大きい。中心付近はほぼ無価値。ちまちま伸ばすというよりは四隅を取りに行くゲームか？

ビジュアライザにmanual modeがあったので手でやってみる。むっず。合法手がどこかもぱっと見だと分からないな。端まで伸ばすとかそういうことを考える余裕がない。適当な貪欲を書いた方が早そう。

点を配置できる場所を考える。ある印の付いていない点p_0を起点に、u方向とv方向に伸ばして点p_1, p_2を見つける。そこからさらに伸ばして、他の点や線分にぶつからずにp_3が見つかればOK。N≦64だからビット演算で高速化できそうだが、斜めの処理がめんどくさそう。ビット演算はとりあえず後回しにして、今日はまず貪欲を完成させることを目標にしよう。

貪欲解を作った。長方形を構築可能な頂点の中から最も重みの大きいものを選ぶだけ。33.2Mで3位。これ外側目指すの難しすぎるな。縦横→斜め→縦横→斜め→……の順で伸ばしていくのだろうか……。

テストケースを捏造して遊んでみる。2本のラインを作って、そこから□と◇を無限に作れると強そう。

強化学習とかできたりする？いやむずそうだけど……。

盤面がデカいんだよなあ。計算量がConv2D 1回あたりΩ(N^2 K^2 C_in C_out)くらいかかるのでヤバそう。

ABCに参加。ギリギリGまで解けた。コンテスト中の橙diffは5回目なので嬉しい。

## 2日目（日）

案の定1位はもう50M点超えてる。長期コンの序盤の点数はアテにならない……。

[Magic Bitboard](https://ipsj.ixsq.nii.ac.jp/ej/index.php?active_action=repository_view_main_item_detail&page_id=13&block_id=8&item_id=71312&item_no=1)というものがあるらしい。メモっておく。まあとりあえずはRotated Bitboardで十分かな。多分書き込みより読み込みの方が多いし。

実装だるすぎてスーパーマリオサンシャインのRTAを観てしまい3時間を消費。攻略本片手に120枚集めた思い出。

どうにか実装。座標変換で頭がこわれそうになったけど思ったほどバグらなかった。サーバ上での実行時間は455ms→119msに短縮。満足……とまではいかないが、まあ4倍速くなったのは大きい。

クラウド実行環境の初期設定をした。 `dotnet tool install` でお手軽にできるようになったのでだいぶ良い。が、設定ファイルの書き方とか忘れてるな。どこかに書き残しておこう。

とりあえず合法手を絶やさないことが大事なゲームなんだろうか。うーん……。

何も考えていないビームを撃った。弱い。ダメだなあ。

選択確率に重みを付けつつ時間いっぱい乱択するやつを作った。37.6Mで28位。こっちの方がまだマシだけど未来がない……。

新しい点の配置候補を列挙するとき、(x, y)で全探索するよりも今存在する点を全探索した方が速くなることにようやく気付いた。修正。

seed=98で1,000,000点を超えていた。見ると□と◇を交互にたくさん作れている。やっぱりこういう形を作り出せると強いっぽい。

## 3日目（月）

乱択貪欲をするときに大きな長方形を選ぶのを避けるようにするとスコアが上がった。40.64Mで18位。言われてみれば確かにという感じだけど、常にこれが正しいのかは謎。

```text
  +
 +
+ * ←なんかここ強いっぽい ←ごめん嘘かも
```

「実は1箇所90°回転させると2つの輪っかを1つにくっつけられます」みたいな天才パズルが求められている？

人間がこういうパズル解くときどうするだろ。DFSっぽくある程度のところまで行って、ダメそうだったら手順を戻して繰り返す？同じような山登りができない？

やってみた。結構伸びた。山登りができるということは焼きなましもできるということなので焼く。43.18Mで13位。こういう焼き方は初めてだなあ。勉強になる。

上手くいっているケース（seed=98）を見ると、1個置いたあとそこから連鎖的に繋げていっている。こういう手を優先するようにすると強い？

1x1の□→1x1の◇→それ以外の順に優先していくようにした。ちょい伸び。

早くも頭打ち感が出てきた。このままやってもあまり期待できなさそうだし、レート上げるなら一発にかける必要があるので強化学習で行けないかチャレンジしてみるか。

[OpenAI Gym／Baselines 深層学習・強化学習 人工知能プログラミング 実践入門](https://amzn.to/3qLWhsI)を買った（今更？）。この人の本、[AlphaZero 深層学習・強化学習・探索 人工知能プログラミング実践入門](https://amzn.to/3Un9aqE)は読んだことがあってかなり良かったんだよな。勉強が間に合うか、間に合っても上手く行くかどうかよく分からないけどやってみる。

ざっと流し読みした。モデルが既知なのにモデルフリーの手法を適用するのはあまり筋が良い方法ではない気がしてきた。今のコードの何が良くないかというと、先読みができないんだよなこれ。MCTS……とまでは行かないが、何かしらの先読みは取り入れたい。

そういえばと思って高速化を行った。合法手の列挙を毎回行うのではなく、新しく可能となった手のみを差分追加するというもの。非合法となった手がゴミとなってたくさん残るが、別に害はないので放っておいてよい。提出すると50.47Mで5位。

今まで合法手の列挙が計算時間のボトルネックになっていたが、今度はランダムサンプリングが計算時間のボトルネックになった。重みの累積和の更新に毎回Θ(N)かかるためで、これはFenwick-Treeを使えば高速化できる。

実行時間を10倍にすると10%くらいスコアが改善しそうだったので、やる。等倍～3倍くらいになった。3%ほどの伸び。

雑な先読み入れてみたけど微妙……なんか伸びそうなビジョンが見えないなあ。

今の焼きなましはランダムなターン数目以降を全部捨てているけど、全部捨てるのはなんかもったいない気がするな。1要素ごとにランダムに残すか捨てるか決めるようにしてみるか。

なんか死ぬほど良くなった。20%も改善とか言われると真っ先にスコア計算バグを疑うんだけど、公式ジャッジツール使ってるから間違ってはいないはず……？投げる。[61.80Mで2位](https://twitter.com/terry_u16/status/1571862645762068483)。マジか。これ焼けるとか嘘だろ……。

焼けるのが信じられなくて「凄いよこの問題……」と言い続けてる。絶対ビームサーチ問だと思ったんだけど。いやビームサーチでも解けるのかもしれないけど。手順間の依存関係が強くて焼きなましは筋が悪いように見えたのだけれど、言われてみればある点が消えることで影響を受ける箇所は意外と少ないのかもしれない。

実行時間を10倍にすれば70M超えるらしい。高速化かあ……。

「ランダムに残すか捨てるか決める」の確率を時間経過で変更させるようにした。63.32M。今日はここまでにするかね。

## 4日目（火）

TODO: 近くにある点を探すとき、主ベクトル+従ベクトルの2つ×8方向を調べていて無駄なのでキャッシュする。

やった。2割くらい速くなった。64.54M。

ちょっと高速化に限界を感じてきた。焼きなましが正解だと決めつけずにもっと色々な可能性を探るべきか……。

まだコンテストの1/4が終わった段階なんだよなあ。同じ2週間コンテストの[AHC008の順位表](https://iilj.github.io/AtCoderMarathonReplay/#/standings/ahc008/2022-02-15T19:00:00+0900)を見ると、開始3日目時点のぶっちぎり1位の点数で1ページ目にすら入れていないんだよな。70M点は目指さないとダメか……。

メモ：実行時間を10倍にしたら73M相当くらい。高速化するか探索を効率化するか……。

## 5日目（水）

飲み会あった上に人身事故で電車が大幅遅延したので何もできませんでした。
